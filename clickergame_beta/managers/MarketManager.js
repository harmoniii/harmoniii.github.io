// managers/MarketManager.js - –°–∏—Å—Ç–µ–º–∞ —Ç–æ—Ä–≥–æ–≤–ª–∏
import { CleanupMixin } from '../core/CleanupManager.js';
import { eventBus, GameEvents } from '../core/GameEvents.js';
import { GAME_CONSTANTS } from '../config/GameConstants.js';
import { getResourceEmoji } from '../config/ResourceConfig.js';

// –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –º–∞—Ä–∫–µ—Ç–∞
export const MARKET_CATEGORIES = {
  resources: 'Basic Resources',
  advanced: 'Advanced Materials',
  special: 'Special Items',
  premium: 'Premium Goods',
  energy: 'Enegry Replenish'
};

// –¢–æ–≤–∞—Ä—ã –º–∞—Ä–∫–µ—Ç–∞
export const ADAPTIVE_MARKET_ITEMS = [
  {
    id: 'wood',
    name: 'Wood',
    icon: 'üå≤',
    description: 'Basic building material',
    basePrice: { gold: 500 }, // —Å–Ω–∏–∂–µ–Ω–æ
    reward: { wood: 1 },
    category: 'resources',
    adaptive: true, // –Ω–æ–≤–æ–µ –ø–æ–ª–µ
    scalingFactor: 1.1 // —Ü–µ–Ω–∞ —Ä–∞—Å—Ç–µ—Ç –Ω–∞ 10% –∑–∞ –∫–∞–∂–¥—É—é –ø–æ–∫—É–ø–∫—É
  },
  {
    id: 'stone',
    name: 'Stone',
    icon: 'ü™®',
    description: 'Construction material',
    basePrice: { gold: 500 },
    reward: { stone: 1 },
    category: 'resources',
    adaptive: true,
    scalingFactor: 1.1
  },
  {
    id: 'energy_pack',
    name: 'Energy Pack',
    icon: '‚ö°',
    description: 'Immediate energy restoration',
    basePrice: { gold: 1000 }, // —Å–Ω–∏–∂–µ–Ω–æ
    reward: { energy: 25 }, // —É–º–µ–Ω—å—à–µ–Ω–æ
    category: 'advanced',
    adaptive: true,
    scalingFactor: 1.15 // —Ä–∞—Å—Ç–µ—Ç –±—ã—Å—Ç—Ä–µ–µ
  },
  {
    id: 'skill_crystal',
    name: 'Skill Crystal',
    icon: 'üíé',
    description: 'Crystallized knowledge',
    basePrice: { gold: 5000, science: 3, faith: 2 }, // —Å–Ω–∏–∂–µ–Ω–æ
    reward: { skillPoints: 2 }, // —É–º–µ–Ω—å—à–µ–Ω–æ —Å 3
    category: 'premium',
    adaptive: true,
    scalingFactor: 1.25 // —Ä–∞—Å—Ç–µ—Ç –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ
  }
];

export class MarketManager extends CleanupMixin {
  constructor(gameState) {
    super();
    
    this.gameState = gameState;
    
    this.initializeMarket();
    
    console.log('üõí MarketManager initialized');
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–∞—Ä–∫–µ—Ç–∞
  initializeMarket() {
    // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –º–∞—Ä–∫–µ—Ç–∞ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    if (!this.gameState.market) {
      this.gameState.market = {
        dailyDeals: [],
        purchaseHistory: [],
        reputation: 0,
        permanentBonuses: {}
      };
    }
    
    // –í–∞–ª–∏–¥–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –º–∞—Ä–∫–µ—Ç–∞
    this.validateMarketData();
  }

  // –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –º–∞—Ä–∫–µ—Ç–∞
  validateMarketData() {
    const market = this.gameState.market;
    
    // –í–∞–ª–∏–¥–∏—Ä—É–µ–º —Ä–µ–ø—É—Ç–∞—Ü–∏—é
    if (typeof market.reputation !== 'number' || isNaN(market.reputation)) {
      market.reputation = 0;
    } else {
      market.reputation = Math.max(0, Math.floor(market.reputation));
    }
    
    // –í–∞–ª–∏–¥–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤—ã
    if (!Array.isArray(market.dailyDeals)) {
      market.dailyDeals = [];
    }
    
    if (!Array.isArray(market.purchaseHistory)) {
      market.purchaseHistory = [];
    }
    
    // –í–∞–ª–∏–¥–∏—Ä—É–µ–º –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –±–æ–Ω—É—Å—ã
    if (!market.permanentBonuses || typeof market.permanentBonuses !== 'object') {
      market.permanentBonuses = {};
    }
    
    // –û—á–∏—â–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –µ—Å–ª–∏ –æ–Ω–∞ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∞—è
    if (market.purchaseHistory.length > 1000) {
      market.purchaseHistory = market.purchaseHistory.slice(-500);
    }
  }

  // –ü–æ–ª—É—á–∏—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
  getItemDefinition(itemId) {
    return MARKET_ITEMS.find(item => item.id === itemId);
  }

calculateAdaptivePrice(itemId) {
  const item = this.getItemDefinition(itemId);
  if (!item || !item.adaptive) {
    return item.price;
  }
  
  // –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–∫—É–ø–æ–∫ —ç—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä–∞
  const purchaseCount = this.gameState.market.purchaseHistory.filter(
    purchase => purchase.itemId === itemId
  ).length;
  
  // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Ü–µ–Ω—É
  const scalingFactor = Math.pow(item.scalingFactor || 1.1, purchaseCount);
  const scaledPrice = {};
  
  Object.entries(item.basePrice).forEach(([resource, amount]) => {
    scaledPrice[resource] = Math.floor(amount * scalingFactor);
  });
  
  return scaledPrice;
}

  // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –º–æ–∂–µ–º –ª–∏ –ø–æ–∑–≤–æ–ª–∏—Ç—å —Å–µ–±–µ —Ç–æ–≤–∞—Ä
canAffordAdaptive(itemId) {
  const item = this.getItemDefinition(itemId);
  if (!item) return false;

  const price = item.adaptive ? 
    this.calculateAdaptivePrice(itemId) : 
    this.calculateEffectivePrice(item.price);
    
  return this.gameState.canAffordResources(price);
}

// –ü–æ–ª—É—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–∫—É–ø–æ–∫ —Ç–æ–≤–∞—Ä–∞
getPurchaseCount(itemId) {
  return this.gameState.market.purchaseHistory.filter(
    purchase => purchase.itemId === itemId
  ).length;
}

  // –ö—É–ø–∏—Ç—å —Ç–æ–≤–∞—Ä
buyItem(itemId) {
  const item = this.getItemDefinition(itemId);
  if (!item) {
    console.warn(`Unknown item: ${itemId}`);
    return false;
  }

  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–¥–∞–ø—Ç–∏–≤–Ω—É—é —Ü–µ–Ω—É
  const effectivePrice = item.adaptive ? 
    this.calculateAdaptivePrice(itemId) : 
    this.calculateEffectivePrice(item.price);

  if (!this.gameState.canAffordResources(effectivePrice)) {
    console.warn(`Cannot afford item ${itemId}`);
    return false;
  }

  if (!this.gameState.spendResources(effectivePrice)) {
    console.warn(`Failed to spend resources for ${itemId}`);
    return false;
  }

  // –í—ã–¥–∞–µ–º –Ω–∞–≥—Ä–∞–¥—ã —Å –≤–æ–∑–º–æ–∂–Ω—ã–º–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏
  if (!this.giveRewardsWithLimits(item.reward, itemId)) {
    this.refundResources(effectivePrice);
    return false;
  }

  // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –ø–æ–∫—É–ø–∫—É —Å –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–π —Ü–µ–Ω–æ–π
  this.recordPurchase(item, effectivePrice);

  // –†–µ–ø—É—Ç–∞—Ü–∏—è —Ä–∞—Å—Ç–µ—Ç –º–µ–¥–ª–µ–Ω–Ω–µ–µ –¥–ª—è –¥–æ—Ä–æ–≥–∏—Ö –ø–æ–∫—É–ø–æ–∫
  const reputationGain = Math.max(1, Math.floor(10 / Math.sqrt(this.getPurchaseCount(itemId) + 1)));
  this.gameState.market.reputation = Math.min(
    this.gameState.market.reputation + reputationGain,
    1000
  );

  eventBus.emit(GameEvents.RESOURCE_CHANGED);
  eventBus.emit(GameEvents.ITEM_PURCHASED, { 
    item: item, 
    reputation: this.gameState.market.reputation,
    adaptivePrice: effectivePrice
  });

  console.log(`Purchased ${item.name} for`, effectivePrice);
  return true;
}

  // –í—ã–¥–∞—Ç—å –Ω–∞–≥—Ä–∞–¥—ã
giveRewardsWithLimits(rewards, itemId) {
  try {
    Object.entries(rewards).forEach(([resource, amount]) => {
      if (resource === 'skillPoints') {
        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –ø–æ–ª—É—á–µ–Ω–∏–µ skill points
        const currentSP = Math.floor(this.gameState.skillPoints || 0);
        const purchaseCount = this.getPurchaseCount(itemId);
        
        // –£–º–µ–Ω—å—à–∞–µ–º –Ω–∞–≥—Ä–∞–¥—É skill points —Å –∫–∞–∂–¥–æ–π –ø–æ–∫—É–ø–∫–æ–π
        const reducedAmount = Math.max(1, Math.floor(amount * Math.pow(0.9, purchaseCount)));
        
        if (this.gameState.skillManager && 
            typeof this.gameState.skillManager.addSkillPoints === 'function') {
          this.gameState.skillManager.addSkillPoints(reducedAmount);
        } else {
          const newSP = Math.min(currentSP + reducedAmount, GAME_CONSTANTS.MAX_SKILL_POINTS);
          this.gameState.skillPoints = newSP;
          eventBus.emit(GameEvents.SKILL_POINTS_CHANGED, this.gameState.skillPoints);
        }
      } else if (resource === 'energy') {
        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —ç–Ω–µ—Ä–≥–∏–∏
        const maxRestore = Math.min(amount, 50); // –Ω–µ –±–æ–ª—å—à–µ 50 –∑–∞ —Ä–∞–∑
        if (this.gameState.energyManager) {
          this.gameState.energyManager.restoreEnergy(maxRestore, 'market_purchase');
        }
      } else if (resource === 'chaos' && amount < 0) {
        // –£–º–µ–Ω—å—à–µ–Ω–∏–µ —Ö–∞–æ—Å–∞
        const currentChaos = this.gameState.resources[resource] || 0;
        const actualReduction = Math.min(Math.abs(amount), currentChaos);
        this.gameState.resources[resource] = currentChaos - actualReduction;
      } else {
        // –û–±—ã—á–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã
        this.gameState.addResource(resource, amount);
      }
    });
    return true;
  } catch (error) {
    console.warn('Error giving rewards:', error);
    return false;
  }
}

  // –í–µ—Ä–Ω—É—Ç—å —Ä–µ—Å—É—Ä—Å—ã
  refundResources(price) {
    try {
      Object.entries(price).forEach(([resource, amount]) => {
        this.gameState.addResource(resource, amount);
      });
    } catch (error) {
      console.warn('Error refunding resources:', error);
    }
  }

  // –ó–∞–ø–∏—Å–∞—Ç—å –ø–æ–∫—É–ø–∫—É –≤ –∏—Å—Ç–æ—Ä–∏—é
  recordPurchase(item, actualPrice) {
    try {
      const purchaseRecord = {
        itemId: item.id,
        timestamp: Date.now(),
        price: { ...actualPrice },
        reward: { ...item.reward },
        reputation: this.gameState.market.reputation
      };

      this.gameState.market.purchaseHistory.push(purchaseRecord);

      // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏
      if (this.gameState.market.purchaseHistory.length > 1000) {
        this.gameState.market.purchaseHistory = 
          this.gameState.market.purchaseHistory.slice(-500);
      }
    } catch (error) {
      console.warn('Error recording purchase:', error);
    }
  }

  // –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–≤–∞—Ä–µ
getItemInfo(itemId) {
  const item = this.getItemDefinition(itemId);
  if (!item) return null;

  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–¥–∞–ø—Ç–∏–≤–Ω—É—é —Ü–µ–Ω—É –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞
  const effectivePrice = item.adaptive ? 
    this.calculateAdaptivePrice(itemId) : 
    this.calculateEffectivePrice(item.price);

  return {
    ...item,
    price: effectivePrice, // –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º —Ü–µ–Ω—É
    canAfford: this.canAffordAdaptive(itemId),
    priceText: this.formatPrice(effectivePrice),
    rewardText: this.formatReward(item.reward),
    effectivePrice: effectivePrice,
    purchaseCount: this.getPurchaseCount(itemId) // –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
  };
}

  // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–≥—Ä–∞–¥—É
  formatReward(reward) {
    return Object.entries(reward)
      .map(([resource, amount]) => {
        const prefix = amount > 0 ? '+' : '';
        const emoji = getResourceEmoji(resource);
        return `${prefix}${amount} ${emoji}`;
      })
      .join(' + ');
  }

  // –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Ç–æ–≤–∞—Ä—ã
  getAllItems() {
    return MARKET_ITEMS.map(item => this.getItemInfo(item.id)).filter(Boolean);
  }

  // –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–≤–∞—Ä—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
  getItemsByCategory() {
    const categories = {};
    
    Object.keys(MARKET_CATEGORIES).forEach(cat => {
      categories[cat] = MARKET_ITEMS
        .filter(item => item.category === cat)
        .map(item => this.getItemInfo(item.id))
        .filter(Boolean);
    });
    
    return categories;
  }

  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –µ–∂–µ–¥–Ω–µ–≤–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
  generateDailyDeals() {
    const dealCount = 3;
    const availableItems = MARKET_ITEMS.filter(item => 
      item.category !== 'premium' // –ò—Å–∫–ª—é—á–∞–µ–º –ø—Ä–µ–º–∏—É–º —Ç–æ–≤–∞—Ä—ã
    );
    
    const deals = [];
    const maxAttempts = availableItems.length * 2;
    let attempts = 0;
    
    while (deals.length < dealCount && attempts < maxAttempts) {
      const item = availableItems[Math.floor(Math.random() * availableItems.length)];
      if (!deals.find(deal => deal.id === item.id)) {
        // –°–æ–∑–¥–∞–µ–º –≤–µ—Ä—Å–∏—é —Ç–æ–≤–∞—Ä–∞ —Å–æ —Å–∫–∏–¥–∫–æ–π
        const discountedItem = {
          ...item,
          id: `${item.id}_deal`,
          price: this.applyDiscount(item.price, 0.8), // 20% —Å–∫–∏–¥–∫–∞
          isDeal: true,
          originalPrice: { ...item.price }
        };
        deals.push(discountedItem);
      }
      attempts++;
    }
    
    this.gameState.market.dailyDeals = deals;
    return deals;
  }

  // –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å–∫–∏–¥–∫—É
  applyDiscount(price, multiplier) {
    const discountedPrice = {};
    Object.entries(price).forEach(([resource, amount]) => {
      discountedPrice[resource] = Math.max(1, Math.floor(amount * multiplier));
    });
    return discountedPrice;
  }

  // –ü–æ–ª—É—á–∏—Ç—å —Ä–µ–ø—É—Ç–∞—Ü–∏—é –º–∞—Ä–∫–µ—Ç–∞
  getMarketReputation() {
    return this.gameState.market.reputation || 0;
  }

  // –ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø–æ–∫—É–ø–æ–∫
  getPurchaseHistory() {
    return this.gameState.market.purchaseHistory || [];
  }

  // –ü–æ–ª—É—á–∏—Ç—å —Å–∫–∏–¥–∫—É –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–ø—É—Ç–∞—Ü–∏–∏
  getReputationDiscount() {
    const reputation = this.getMarketReputation();
    if (reputation >= 100) return 0.85; // 15% —Å–∫–∏–¥–∫–∞
    if (reputation >= 50) return 0.9;   // 10% —Å–∫–∏–¥–∫–∞
    if (reputation >= 25) return 0.95;  // 5% —Å–∫–∏–¥–∫–∞
    return 1.0; // –ë–µ–∑ —Å–∫–∏–¥–∫–∏
  }

  // –ü–æ–ª—É—á–∏—Ç—å –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –±–æ–Ω—É—Å—ã
  getPermanentBonuses() {
    return this.gameState.market.permanentBonuses || {};
  }

  // –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –º–∞—Ä–∫–µ—Ç–∞
  getMarketStats() {
    const history = this.getPurchaseHistory();
    const now = Date.now();
    const dayMs = 24 * 60 * 60 * 1000;
    
    return {
      totalPurchases: history.length,
      todayPurchases: history.filter(p => now - p.timestamp < dayMs).length,
      reputation: this.getMarketReputation(),
      discount: Math.floor((1 - this.getReputationDiscount()) * 100),
      favoriteCategory: this.getFavoriteCategory(history),
      totalSpent: this.calculateTotalSpent(history),
      permanentBonuses: this.getPermanentBonuses()
    };
  }

  // –ü–æ–ª—É—á–∏—Ç—å –ª—é–±–∏–º—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
  getFavoriteCategory(history) {
    const categoryCount = {};
    
    history.forEach(purchase => {
      const item = MARKET_ITEMS.find(i => i.id === purchase.itemId);
      if (item) {
        categoryCount[item.category] = (categoryCount[item.category] || 0) + 1;
      }
    });
    
    let maxCount = 0;
    let favoriteCategory = 'none';
    
    Object.entries(categoryCount).forEach(([category, count]) => {
      if (count > maxCount) {
        maxCount = count;
        favoriteCategory = category;
      }
    });
    
    return MARKET_CATEGORIES[favoriteCategory] || favoriteCategory;
  }

  // –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –æ–±—â–∏–µ —Ç—Ä–∞—Ç—ã
  calculateTotalSpent(history) {
    const totalSpent = {};
    
    history.forEach(purchase => {
      Object.entries(purchase.price).forEach(([resource, amount]) => {
        totalSpent[resource] = (totalSpent[resource] || 0) + amount;
      });
    });
    
    return totalSpent;
  }

  // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ç–æ–≤–∞—Ä–∞
  isItemUnlocked(itemId) {
    // –ü—Ä–æ—Å—Ç–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ - –º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å
    const basicItems = ['wood', 'stone', 'food', 'water', 'iron', 'resource_bundle'];
    if (basicItems.includes(itemId)) {
      return true;
    }

    // –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ —Ç–æ–≤–∞—Ä—ã —Ç—Ä–µ–±—É—é—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
    const advancedItems = ['energy_pack', 'science_book'];
    if (advancedItems.includes(itemId)) {
      return this.gameState.resources.energy >= 1 || this.gameState.resources.science >= 1;
    }

    // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã —Ç—Ä–µ–±—É—é—Ç –≤–µ—Ä—ã –∏–ª–∏ –Ω–∞—É–∫–∏
    const specialItems = ['faith_relic', 'chaos_neutralizer'];
    if (specialItems.includes(itemId)) {
      return this.gameState.resources.faith >= 5 || this.gameState.resources.science >= 3;
    }

    // –ü—Ä–µ–º–∏—É–º —Ç–æ–≤–∞—Ä—ã —Ç—Ä–µ–±—É—é—Ç –≤—ã—Å–æ–∫–æ–π —Ä–µ–ø—É—Ç–∞—Ü–∏–∏
    const premiumItems = ['skill_crystal', 'golden_charm'];
    if (premiumItems.includes(itemId)) {
      return this.getMarketReputation() >= 50;
    }

    return true;
  }

  // –ü–æ–ª—É—á–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã
  getRecommendedItems() {
    const recommendations = [];
    const currentResources = this.gameState.resources;
    
    // –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º —Ä–µ—Å—É—Ä—Å—ã, –∫–æ—Ç–æ—Ä—ã—Ö –º–∞–ª–æ
    Object.entries(currentResources).forEach(([resource, amount]) => {
      if (amount < 10) {
        const item = MARKET_ITEMS.find(i => 
          i.reward[resource] && i.reward[resource] > 0
        );
        if (item && this.canAfford(item.id)) {
          recommendations.push({
            ...this.getItemInfo(item.id),
            reason: `Low ${resource} (${amount})`
          });
        }
      }
    });
    
    // –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º skill crystal –µ—Å–ª–∏ –º–Ω–æ–≥–æ –∑–æ–ª–æ—Ç–∞
    if (currentResources.gold > 30000 && this.canAfford('skill_crystal')) {
      recommendations.push({
        ...this.getItemInfo('skill_crystal'),
        reason: 'Invest excess gold in skill points'
      });
    }
    
    return recommendations.slice(0, 3); // –ú–∞–∫—Å–∏–º—É–º 3 —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
  }

  // –î–µ—Å—Ç—Ä—É–∫—Ç–æ—Ä
  destroy() {
    console.log('üßπ MarketManager cleanup started');
    
    // –í—ã–∑—ã–≤–∞–µ–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –¥–µ—Å—Ç—Ä—É–∫—Ç–æ—Ä
    super.destroy();
    
    console.log('‚úÖ MarketManager destroyed');
  }
}