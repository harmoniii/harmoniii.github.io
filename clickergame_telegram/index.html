<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
  <title>Restoration: Chronicles of Survival - Grid Clicker</title>
  
  <!-- Telegram Web App Script -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  
  <!-- Telegram Web App Meta Tags -->
  <meta name="telegram-app" content="true">
  
  <!-- CSS ÑÑ‚Ğ¸Ğ»Ğ¸ Ğ´Ğ»Ñ Telegram -->
  <link rel="stylesheet" href="unified-telegram-styles.css">
  <link rel="stylesheet" href="telegram-styles.css">
  <link rel="stylesheet" href="styles.css">
</head>
<body class="telegram-webapp">
  <!-- Ğ˜Ğ½Ğ´Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ´Ğ»Ñ Telegram -->
  <div id="telegram-loading" class="telegram-loading">
    <div class="loading-spinner"></div>
    <div class="loading-text">ğŸ® Loading Grid Clicker...</div>
  </div>

  <!-- Ğ’ĞµÑ€Ñ…Ğ½ÑÑ Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ Ğ½Ğ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸Ğ¸ -->
  <div id="ui-top" class="telegram-hidden-controls">
    <button id="toggle-buildings">ğŸ—ï¸ Buildings</button>
    <button id="toggle-skills">ğŸ¯ Skills</button>
    <button id="toggle-raids" style="display: none;">âš”ï¸ Raids</button>
    <button id="toggle-market">ğŸ›’ Market</button>
    <button id="info-button">ğŸ“š Info</button>
  </div>

  <!-- ĞÑĞ½Ğ¾Ğ²Ğ½Ğ°Ñ Ğ¸Ğ³Ñ€Ğ¾Ğ²Ğ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ -->
  <div id="game-area" class="telegram-game-area">
    <div class="grid-game-container">
      
      <!-- Ğ›ĞµĞ²Ğ°Ñ Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ Ñ Ñ€ĞµÑÑƒÑ€ÑĞ°Ğ¼Ğ¸ -->
      <div class="left-panel telegram-panel">
        <div class="resources-section">
          <h4>ğŸ“¦ Basic</h4>
          <div id="basic-resources" class="resources-group"></div>
        </div>
        
        <div class="resources-section">
          <h4>âš—ï¸ Advanced</h4>
          <div id="advanced-resources" class="resources-group"></div>
        </div>
        
        <div class="resources-section">
          <h4>âœ¨ Special</h4>
          <div id="special-resources" class="resources-group"></div>
        </div>
      </div>

      <!-- Ğ˜Ğ³Ñ€Ğ¾Ğ²Ğ°Ñ ÑĞµÑ‚ĞºĞ° Ğ¿Ğ¾ Ñ†ĞµĞ½Ñ‚Ñ€Ñƒ -->
      <div class="game-grid-center">
        <canvas id="gameCanvas" width="350" height="350"></canvas>
      </div>

      <!-- ĞŸÑ€Ğ°Ğ²Ğ°Ñ Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸ĞµĞ¹ -->
      <div class="right-panel telegram-panel">
        
        <!-- ĞšĞ¾Ğ¼Ğ±Ğ¾ Ğ¸Ğ½Ğ´Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€ -->
        <div class="combo-indicator" id="combo-indicator">
          <div class="combo-title">COMBO</div>
          <div class="combo-value" id="combo-value">0</div>
          <div class="combo-bonus" id="combo-bonus">Hit the target!</div>
        </div>

        <!-- Ğ­Ğ½ĞµÑ€Ğ³Ğ¸Ñ -->
        <div class="energy-display-container" id="energy-display">
          <div class="energy-bar-container">
            <div class="energy-bar-background">
              <div class="energy-bar energy-normal" id="energy-bar"></div>
            </div>
          </div>
          <div class="energy-text" id="energy-text">âš¡ 100/100</div>
          <div class="energy-status ready" id="energy-status">Ready!</div>
          <div class="energy-warning hidden" id="energy-warning">âš¡ Low!</div>
        </div>
        
      </div>
    </div>

    <!-- Ğ‘Ñ‹ÑÑ‚Ñ€Ñ‹Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ Ğ´Ğ»Ñ Telegram -->
    <div class="telegram-quick-actions">
      <button id="tg-buildings-btn" class="tg-action-btn">ğŸ—ï¸</button>
      <button id="tg-skills-btn" class="tg-action-btn">ğŸ¯</button>
      <button id="tg-raids-btn" class="tg-action-btn" style="display: none;">âš”ï¸</button>
      <button id="tg-market-btn" class="tg-action-btn">ğŸ›’</button>
    </div>
  </div>

  <!-- ĞŸĞ°Ğ½ĞµĞ»ÑŒ ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚Ğ° -->
  <div id="panel-container" class="list-panel hidden telegram-panel"></div>

  <!-- ĞĞ¸Ğ¶Ğ½Ğ¸Ğµ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ (ÑĞºÑ€Ñ‹Ñ‚Ñ‹ Ğ² Telegram) -->
  <div id="controls-bottom" class="telegram-hidden-controls">
    <button id="load-button">ğŸ“ Load</button>
    <button id="save-button">ğŸ’¾ Save</button>
    <button id="reset-button">ğŸ”„ Reset</button>
    <button disabled>Beta v1.0</button>
  </div>

  <!-- Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ğµ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ñ‹ -->
  <div id="notifications"></div>
  <div id="mystery-modal" class="modal hidden"></div>
  <div id="info-modal" class="modal hidden"></div>
  <div id="effect-indicators" class="effect-indicators"></div>

  <!-- Telegram Web App Scripts -->
  <script type="module">
    // Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ñ‹ Ğ´Ğ»Ñ Telegram Web App
    import { TelegramWebAppAdapter } from './telegram-webapp-adapter.js';
    import { initializeTelegramGame } from './telegram-game-integration.js';

    console.log('ğŸ¤– Starting Telegram Web App initialization...');

    // Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº
    window.addEventListener('error', (event) => {
      console.error('ğŸ’€ Global error:', event.error);
      
      // ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ
      const errorDiv = document.createElement('div');
      errorDiv.style.cssText = `
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: var(--tg-secondary-bg-color, #f7f7f7);
        color: var(--tg-text-color, #000);
        padding: 2rem; border-radius: 12px; z-index: 10000;
        text-align: center; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3); max-width: 90%; word-wrap: break-word;
      `;
      
      errorDiv.innerHTML = `
        <h3>ğŸ’€ Error</h3>
        <p>${event.error?.message || 'Unknown error occurred'}</p>
        <button onclick="location.reload()" style="
          background: var(--tg-button-color, #007aff); color: var(--tg-button-text-color, white);
          border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;
          font-weight: bold; margin: 0.25rem;
        ">ğŸ”„ Reload</button>
      `;
      
      document.body.appendChild(errorDiv);
    });

    // Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Telegram Web App
    async function initializeTelegram() {
      try {
        console.log('ğŸ¤– Initializing Telegram Web App adapter...');
        
        // Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ°Ğ´Ğ°Ğ¿Ñ‚ĞµÑ€ Telegram
        const telegramAdapter = new TelegramWebAppAdapter();
        
        // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ°Ğ´Ğ°Ğ¿Ñ‚ĞµÑ€ Ğ² Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½ÑƒÑ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ
        window.telegramAdapter = telegramAdapter;
        
        console.log('âœ… Telegram adapter created');
        
        // Ğ–Ğ´ĞµĞ¼ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸ DOM
        if (document.readyState === 'loading') {
          await new Promise(resolve => document.addEventListener('DOMContentLoaded', resolve));
        }
        
        console.log('ğŸ“„ DOM ready, hiding loading screen...');
        
        // Ğ¡ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¾Ñ‡Ğ½Ñ‹Ğ¹ ÑĞºÑ€Ğ°Ğ½
        const loadingElement = document.getElementById('telegram-loading');
        if (loadingElement) {
          loadingElement.style.opacity = '0';
          setTimeout(() => {
            loadingElement.style.display = 'none';
          }, 300);
        }

        // ĞĞ°ÑÑ‚Ñ€Ğ°Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ Ğ´Ğ»Ñ Telegram
        setupTelegramUI();
        
        console.log('ğŸ® Starting game initialization...');
        
        // Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½ÑƒÑ Ğ¸Ğ³Ñ€Ñƒ
        const gameCore = await initializeTelegramGame();
        
        if (gameCore) {
          console.log('ğŸ® Game core initialized, setting up integration...');
          
          // Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ¸Ñ€ÑƒĞµĞ¼ Ñ Telegram Ğ¿Ğ¾ÑĞ»Ğµ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ¸Ğ³Ñ€Ñ‹
          telegramAdapter.setupGameIntegration(gameCore);
          telegramAdapter.bindGameEvents();
          
          // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ² Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½ÑƒÑ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ»Ğ°Ğ´ĞºĞ¸
          window.gameCore = gameCore;
          
          console.log('âœ… Telegram Web App fully initialized');
          
          // Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ÑĞµĞ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
          if (telegramAdapter.hapticFeedback) {
            telegramAdapter.hapticFeedback('success');
          }
          
          // ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾Ğ± ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾Ğ¹ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞµ
          setTimeout(() => {
            if (gameCore.managers?.ui?.notificationManager) {
              gameCore.managers.ui.notificationManager.showSuccess('ğŸ® Game loaded successfully!');
            }
          }, 1000);
        } else {
          throw new Error('Game core initialization failed');
        }
        
      } catch (error) {
        console.error('âŒ Failed to initialize Telegram Web App:', error);
        handleInitializationError(error);
      }
    }

    // ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° UI Ğ´Ğ»Ñ Telegram
    function setupTelegramUI() {
      console.log('ğŸ¨ Setting up Telegram UI...');
      
      // ĞĞ°ÑÑ‚Ñ€Ğ°Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ±Ñ‹ÑÑ‚Ñ€Ñ‹Ğµ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ´Ğ»Ñ Telegram
      const quickActions = {
        'tg-buildings-btn': 'buildings',
        'tg-skills-btn': 'skills', 
        'tg-raids-btn': 'raids',
        'tg-market-btn': 'market'
      };

      Object.entries(quickActions).forEach(([buttonId, panelType]) => {
        const button = document.getElementById(buttonId);
        if (button) {
          button.addEventListener('click', () => {
            console.log(`ğŸ“± Quick action clicked: ${panelType}`);
            
            // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ haptic feedback
            if (window.telegramAdapter?.hapticFeedback) {
              window.telegramAdapter.hapticFeedback('selection');
            }
            
            // ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ÑƒÑÑ‰ÑƒÑ Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ
            if (window.gameCore?.managers?.ui) {
              window.gameCore.managers.ui.showPanel(panelType);
            }
          });
        }
      });

      // Ğ¡ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ½ĞµĞ½ÑƒĞ¶Ğ½Ñ‹Ğµ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ñ‹ Ğ² Telegram
      const hiddenElements = document.querySelectorAll('.telegram-hidden-controls');
      hiddenElements.forEach(el => {
        el.style.display = 'none';
      });

      // ĞĞ´Ğ°Ğ¿Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€Ñ‹ Ğ´Ğ»Ñ Telegram
      const canvas = document.getElementById('gameCanvas');
      if (canvas) {
        const viewportHeight = window.telegramAdapter?.tg?.viewportHeight || window.innerHeight;
        
        if (viewportHeight < 600) {
          canvas.width = 280;
          canvas.height = 280;
          canvas.style.width = '280px';
          canvas.style.height = '280px';
        } else {
          canvas.width = 350;
          canvas.height = 350;
          canvas.style.width = '350px';
          canvas.style.height = '350px';
        }
      }

      // ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ Ñ‚ĞµĞ¼Ñƒ Telegram
      applyTelegramTheme();

      console.log('âœ… Telegram UI setup completed');
    }

    // ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ñ‚ĞµĞ¼Ñ‹ Telegram
    function applyTelegramTheme() {
      const telegramAdapter = window.telegramAdapter;
      if (!telegramAdapter?.tg?.themeParams) return;

      const theme = telegramAdapter.tg.themeParams;
      const root = document.documentElement;

      // ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ Ñ†Ğ²ĞµÑ‚Ğ° Ñ‚ĞµĞ¼Ñ‹
      if (theme.bg_color) root.style.setProperty('--tg-bg-color', theme.bg_color);
      if (theme.text_color) root.style.setProperty('--tg-text-color', theme.text_color);
      if (theme.hint_color) root.style.setProperty('--tg-hint-color', theme.hint_color);
      if (theme.link_color) root.style.setProperty('--tg-link-color', theme.link_color);
      if (theme.button_color) root.style.setProperty('--tg-button-color', theme.button_color);
      if (theme.button_text_color) root.style.setProperty('--tg-button-text-color', theme.button_text_color);

      // Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ ĞºĞ»Ğ°ÑÑ Ñ‚ĞµĞ¼Ñ‹
      if (telegramAdapter.tg.colorScheme === 'dark') {
        document.body.classList.add('tg-dark-theme');
        document.body.classList.remove('tg-light-theme');
      } else {
        document.body.classList.add('tg-light-theme');
        document.body.classList.remove('tg-dark-theme');
      }

      console.log('ğŸ¨ Telegram theme applied:', telegramAdapter.tg.colorScheme);
    }

    // ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
    function handleInitializationError(error) {
      console.error('ğŸ’€ Initialization error:', error);
      
      const loadingElement = document.getElementById('telegram-loading');
      if (loadingElement) {
        loadingElement.innerHTML = `
          <div style="text-align: center; padding: 2rem; color: red;">
            <h3>âŒ Loading Error</h3>
            <p>Failed to load the game: ${error.message}</p>
            <button onclick="location.reload()" style="
              background: #ff3b30; color: white; border: none;
              padding: 1rem 2rem; border-radius: 8px; cursor: pointer;
              font-weight: bold; margin-top: 1rem;
            ">ğŸ”„ Reload Game</button>
            <div style="margin-top: 1rem; font-size: 0.8rem; opacity: 0.7;">
              This error will be reported to the developer.
            </div>
          </div>
        `;
      }

      // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¾Ñ‚Ñ‡ĞµÑ‚ Ğ¾Ğ± Ğ¾ÑˆĞ¸Ğ±ĞºĞµ ĞµÑĞ»Ğ¸ Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾
      if (window.telegramAdapter?.sendData) {
        try {
          window.telegramAdapter.sendData(JSON.stringify({
            type: 'initialization_error',
            error: {
              message: error.message,
              stack: error.stack,
              timestamp: Date.now()
            },
            user: window.telegramAdapter.getUserInfo(),
            userAgent: navigator.userAgent,
            url: window.location.href
          }));
        } catch (reportError) {
          console.error('Failed to report error:', reportError);
        }
      }
    }

    // Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Ğ´Ğ»Ñ Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°
    window.getTelegramDebugInfo = () => {
      return {
        adapter: window.telegramAdapter?.getDebugInfo(),
        gameCore: window.gameCore?.getGameStats(),
        telegramAPI: !!window.Telegram?.WebApp,
        viewport: {
          height: window.telegramAdapter?.tg?.viewportHeight,
          stableHeight: window.telegramAdapter?.tg?.viewportStableHeight,
          isExpanded: window.telegramAdapter?.tg?.isExpanded
        }
      };
    };

    window.exportGameForBot = async () => {
      if (!window.gameCore?.gameState) {
        console.error('Game not initialized');
        return false;
      }

      try {
        const success = await window.telegramStorageManager?.exportForTelegramBot?.(window.gameCore.gameState);
        if (success) {
          console.log('ğŸ“¤ Game data exported to bot');
          if (window.telegramAdapter?.hapticFeedback) {
            window.telegramAdapter.hapticFeedback('success');
          }
        }
        return success;
      } catch (error) {
        console.error('âŒ Export failed:', error);
        return false;
      }
    };

    // Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ
    initializeTelegram();
  </script>

  <!-- ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ ÑĞºÑ€Ğ¸Ğ¿Ñ‚Ñ‹ Ğ¸Ğ³Ñ€Ñ‹ -->
  <script type="module" src="game.js"></script>
</body>
</html>