<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
  <title>Restoration: Chronicles of Survival - Grid Clicker</title>
  
  <!-- Telegram Web App Script -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  
  <!-- –ï–¥–∏–Ω—ã–π CSS —Å—Ç–∏–ª—å -->
  <link rel="stylesheet" href="unified-styles.css">
</head>
<body class="telegram-webapp">

  <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
  <div id="telegram-loading" class="telegram-loading">
    <div class="loading-spinner"></div>
    <div class="loading-text">üéÆ Loading Grid Clicker...</div>
  </div>

  <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è (—Å–∫—Ä—ã—Ç–∞ –≤ Telegram) -->
  <div id="ui-top" class="telegram-hidden-controls">
    <!-- –ö–Ω–æ–ø–∫–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –≤ UIManager -->
  </div>

  <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–≥—Ä–æ–≤–∞—è –æ–±–ª–∞—Å—Ç—å -->
  <div id="game-area" class="telegram-game-area">
    <div class="grid-game-container">
      
      <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å —Ä–µ—Å—É—Ä—Å–∞–º–∏ -->
      <div class="left-panel telegram-panel">
        <div class="resources-section">
          <h4>üì¶ Basic</h4>
          <div id="basic-resources" class="resources-group"></div>
        </div>
        
        <div class="resources-section">
          <h4>‚öóÔ∏è Advanced</h4>
          <div id="advanced-resources" class="resources-group"></div>
        </div>
        
        <div class="resources-section">
          <h4>‚ú® Special</h4>
          <div id="special-resources" class="resources-group"></div>
        </div>
      </div>

      <!-- –ò–≥—Ä–æ–≤–∞—è —Å–µ—Ç–∫–∞ –ø–æ —Ü–µ–Ω—Ç—Ä—É -->
      <div class="game-grid-center">
        <canvas id="gameCanvas" width="350" height="350"></canvas>
      </div>

      <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π -->
      <div class="right-panel telegram-panel">
        
        <!-- –ö–æ–º–±–æ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä -->
        <div class="combo-indicator" id="combo-indicator">
          <div class="combo-title">COMBO</div>
          <div class="combo-value" id="combo-value">0</div>
          <div class="combo-bonus" id="combo-bonus">Hit the target!</div>
        </div>

        <!-- –≠–Ω–µ—Ä–≥–∏—è -->
        <div class="energy-display-container" id="energy-display">
          <div class="energy-bar-container">
            <div class="energy-bar-background">
              <div class="energy-bar energy-normal" id="energy-bar"></div>
            </div>
          </div>
          <div class="energy-text" id="energy-text">‚ö° 100/100</div>
          <div class="energy-status ready" id="energy-status">Ready!</div>
          <div class="energy-warning hidden" id="energy-warning">‚ö° Low!</div>
        </div>
        
      </div>
    </div>

    <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è Telegram -->
    <div class="telegram-quick-actions">
      <!-- –ö–Ω–æ–ø–∫–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –≤ UIManager -->
    </div>
  </div>

  <!-- –ü–∞–Ω–µ–ª—å –∫–æ–Ω—Ç–µ–Ω—Ç–∞ -->
  <div id="panel-container" class="list-panel hidden"></div>

  <!-- –ö–æ–Ω—Ç—Ä–æ–ª—ã —Å–Ω–∏–∑—É (—Å–∫—Ä—ã—Ç—ã –≤ Telegram) -->
  <div id="controls-bottom" class="telegram-hidden-controls">
    <button id="load-button">üìÅ Load</button>
    <button id="save-button">üíæ Save</button>
    <button id="reset-button">üîÑ Reset</button>
    <button disabled>Beta v1.3</button>
  </div>

  <!-- –°–∏—Å—Ç–µ–º–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã -->
  <div id="notifications"></div>
  <div id="mystery-modal" class="modal hidden"></div>
  <div id="info-modal" class="modal hidden"></div>
  <div id="effect-indicators"></div>

  <!-- Telegram Web App Scripts -->
  <script type="module">
    // –ò–º–ø–æ—Ä—Ç—ã –¥–ª—è Telegram Web App
    import { TelegramWebAppAdapter } from './telegram-webapp-adapter.js';
    import { initializeTelegramGame } from './telegram-game-integration.js';

    console.log('ü§ñ Starting Telegram Web App initialization...');

    // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
    window.addEventListener('error', (event) => {
      console.error('üíÄ Global error:', event.error);
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ—à–∏–±–∫—É
      const errorDiv = document.createElement('div');
      errorDiv.style.cssText = `
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: var(--tg-secondary-bg-color, #f7f7f7);
        color: var(--tg-text-color, #000);
        padding: 2rem; border-radius: 12px; z-index: 10000;
        text-align: center; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3); max-width: 90%; word-wrap: break-word;
      `;
      
      errorDiv.innerHTML = `
        <h3>üíÄ Error</h3>
        <p>${event.error?.message || 'Unknown error occurred'}</p>
        <button onclick="location.reload()" style="
          background: var(--tg-button-color, #007aff); color: var(--tg-button-text-color, white);
          border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;
          font-weight: bold; margin: 0.25rem;
        ">üîÑ Reload</button>
      `;
      
      document.body.appendChild(errorDiv);
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
    async function initializeTelegram() {
      try {
        console.log('ü§ñ Initializing Telegram Web App adapter...');
        
        // –°–æ–∑–¥–∞–µ–º –∞–¥–∞–ø—Ç–µ—Ä Telegram
        const telegramAdapter = new TelegramWebAppAdapter();
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∞–¥–∞–ø—Ç–µ—Ä –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å
        window.telegramAdapter = telegramAdapter;
        
        console.log('‚úÖ Telegram adapter created');
        
        // –ñ–¥–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ DOM
        if (document.readyState === 'loading') {
          await new Promise(resolve => document.addEventListener('DOMContentLoaded', resolve));
        }
        
        console.log('üìÑ DOM ready, hiding loading screen...');
        
        // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–æ—á–Ω—ã–π —ç–∫—Ä–∞–Ω
        const loadingElement = document.getElementById('telegram-loading');
        if (loadingElement) {
          loadingElement.style.opacity = '0';
          setTimeout(() => {
            loadingElement.style.display = 'none';
          }, 300);
        }

        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è Telegram
        setupTelegramUI();
        
        console.log('üéÆ Starting game initialization...');
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –∏–≥—Ä—É
        const gameCore = await initializeTelegramGame();
        
        if (gameCore) {
          console.log('üéÆ Game core initialized, setting up integration...');
          
          // –ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ–º —Å Telegram –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–≥—Ä—ã
          telegramAdapter.setupGameIntegration(gameCore);
          telegramAdapter.bindGameEvents();
          
          // –î–æ–±–∞–≤–ª—è–µ–º –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
          window.gameCore = gameCore;
          
          console.log('‚úÖ Telegram Web App fully initialized');
          
          // –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          if (telegramAdapter.hapticFeedback) {
            telegramAdapter.hapticFeedback('success');
          }
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–µ
          setTimeout(() => {
            if (gameCore.managers?.ui?.notificationManager) {
              gameCore.managers.ui.notificationManager.showSuccess('üéÆ Game loaded successfully!');
            }
          }, 1000);
        } else {
          throw new Error('Game core initialization failed');
        }
        
      } catch (error) {
        console.error('‚ùå Failed to initialize Telegram Web App:', error);
        handleInitializationError(error);
      }
    }

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ UI –¥–ª—è Telegram
    function setupTelegramUI() {
      console.log('üé® Setting up Telegram UI...');
      
      // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –±—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è Telegram
      const quickActions = {
        'tg-buildings-btn': 'buildings',
        'tg-skills-btn': 'skills', 
        'tg-raids-btn': 'raids',
        'tg-market-btn': 'market'
      };

      Object.entries(quickActions).forEach(([buttonId, panelType]) => {
        const button = document.getElementById(buttonId);
        if (button) {
          button.addEventListener('click', () => {
            console.log(`üì± Quick action clicked: ${panelType}`);
            
            // –î–æ–±–∞–≤–ª—è–µ–º haptic feedback
            if (window.telegramAdapter?.hapticFeedback) {
              window.telegramAdapter.hapticFeedback('selection');
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –ø–∞–Ω–µ–ª—å
            if (window.gameCore?.managers?.ui) {
              window.gameCore.managers.ui.showPanel(panelType);
            }
          });
        }
      });

      // –°–∫—Ä—ã–≤–∞–µ–º –Ω–µ–Ω—É–∂–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –≤ Telegram
      const hiddenElements = document.querySelectorAll('.telegram-hidden-controls');
      hiddenElements.forEach(el => {
        el.style.display = 'none';
      });

      // –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º —Ä–∞–∑–º–µ—Ä—ã –¥–ª—è Telegram
      const canvas = document.getElementById('gameCanvas');
      if (canvas) {
        const viewportHeight = window.telegramAdapter?.tg?.viewportHeight || window.innerHeight;
        
        if (viewportHeight < 600) {
          canvas.width = 280;
          canvas.height = 280;
          canvas.style.width = '280px';
          canvas.style.height = '280px';
        } else {
          canvas.width = 350;
          canvas.height = 350;
          canvas.style.width = '350px';
          canvas.style.height = '350px';
        }
      }

      // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É Telegram
      applyTelegramTheme();

      console.log('‚úÖ Telegram UI setup completed');
    }

    // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ç–µ–º—ã Telegram
    function applyTelegramTheme() {
      const telegramAdapter = window.telegramAdapter;
      if (!telegramAdapter?.tg?.themeParams) return;

      const theme = telegramAdapter.tg.themeParams;
      const root = document.documentElement;

      // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ü–≤–µ—Ç–∞ —Ç–µ–º—ã
      if (theme.bg_color) root.style.setProperty('--tg-bg-color', theme.bg_color);
      if (theme.text_color) root.style.setProperty('--tg-text-color', theme.text_color);
      if (theme.hint_color) root.style.setProperty('--tg-hint-color', theme.hint_color);
      if (theme.link_color) root.style.setProperty('--tg-link-color', theme.link_color);
      if (theme.button_color) root.style.setProperty('--tg-button-color', theme.button_color);
      if (theme.button_text_color) root.style.setProperty('--tg-button-text-color', theme.button_text_color);

      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–ª–∞—Å—Å —Ç–µ–º—ã
      if (telegramAdapter.tg.colorScheme === 'dark') {
        document.body.classList.add('tg-dark-theme');
        document.body.classList.remove('tg-light-theme');
      } else {
        document.body.classList.add('tg-light-theme');
        document.body.classList.remove('tg-dark-theme');
      }

      console.log('üé® Telegram theme applied:', telegramAdapter.tg.colorScheme);
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    function handleInitializationError(error) {
      console.error('üíÄ Initialization error:', error);
      
      const loadingElement = document.getElementById('telegram-loading');
      if (loadingElement) {
        loadingElement.innerHTML = `
          <div style="text-align: center; padding: 2rem; color: red;">
            <h3>‚ùå Loading Error</h3>
            <p>Failed to load the game: ${error.message}</p>
            <button onclick="location.reload()" style="
              background: #ff3b30; color: white; border: none;
              padding: 1rem 2rem; border-radius: 8px; cursor: pointer;
              font-weight: bold; margin-top: 1rem;
            ">üîÑ Reload Game</button>
            <div style="margin-top: 1rem; font-size: 0.8rem; opacity: 0.7;">
              This error will be reported to the developer.
            </div>
          </div>
        `;
      }

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç—á–µ—Ç –æ–± –æ—à–∏–±–∫–µ –µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ
      if (window.telegramAdapter?.sendData) {
        try {
          window.telegramAdapter.sendData(JSON.stringify({
            type: 'initialization_error',
            error: {
              message: error.message,
              stack: error.stack,
              timestamp: Date.now()
            },
            user: window.telegramAdapter.getUserInfo(),
            userAgent: navigator.userAgent,
            url: window.location.href
          }));
        } catch (reportError) {
          console.error('Failed to report error:', reportError);
        }
      }
    }

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
    window.getTelegramDebugInfo = () => {
      return {
        adapter: window.telegramAdapter?.getDebugInfo(),
        gameCore: window.gameCore?.getGameStats(),
        telegramAPI: !!window.Telegram?.WebApp,
        viewport: {
          height: window.telegramAdapter?.tg?.viewportHeight,
          stableHeight: window.telegramAdapter?.tg?.viewportStableHeight,
          isExpanded: window.telegramAdapter?.tg?.isExpanded
        }
      };
    };

    window.exportGameForBot = async () => {
      if (!window.gameCore?.gameState) {
        console.error('Game not initialized');
        return false;
      }

      try {
        const success = await window.telegramStorageManager?.exportForTelegramBot?.(window.gameCore.gameState);
        if (success) {
          console.log('üì§ Game data exported to bot');
          if (window.telegramAdapter?.hapticFeedback) {
            window.telegramAdapter.hapticFeedback('success');
          }
        }
        return success;
      } catch (error) {
        console.error('‚ùå Export failed:', error);
        return false;
      }
    };

    // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
    initializeTelegram();
  </script>

  <!-- –û—Å–Ω–æ–≤–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã –∏–≥—Ä—ã -->
  <script type="module" src="game.js"></script>
</body>
</html>